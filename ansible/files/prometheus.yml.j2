# files/prometheus.yml.j2
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Application VMs
  - job_name: 'python-app'
    metrics_path: /metrics
    static_configs:
      - targets:
{% for host in groups['app_nodes'] %}
        - '{{ hostvars[host].ansible_host }}:5000'
{% endfor %}

  # Node Exporters on all VMs
  - job_name: 'node-exporter'
    static_configs:
      - targets:
{% for host in groups['all_vms'] %}
        - '{{ hostvars[host].ansible_host }}:9100'
{% endfor %}
        labels:
          group: 'infrastructure'

  # Pushgateway on Selenium VM (for synthetic monitoring metrics)
  - job_name: 'pushgateway'
    scrape_interval: 15s
    honor_labels: true  # CRITICAL: Preserves job labels from pushed metrics
    static_configs:
      - targets: ["{{ hostvars[groups['selenium_node'][0]]['ansible_host'] }}:9091"]
