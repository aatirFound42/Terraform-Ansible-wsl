# ansible/playbook.yml - Multi-VM Deployment Strategy
---
# =========================================================================
# PLAY 1: Setup All VMs with Docker and Node Exporter
# =========================================================================
- name: Setup Docker and Node Exporter on All VMs
  hosts: all_vms
  become: true
  vars:
    docker_version: "5:24.0.0-1~ubuntu.22.04~jammy"
    app_user: "{{ ansible_user }}"
    node_exporter_port: 9100

  tasks:
    - name: Display VM setup information
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Setting up: {{ inventory_hostname }}"
          - "IP: {{ ansible_host | default(ansible_default_ipv4.address) }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # -------------------------------------------------------
    # System Preparation
    # -------------------------------------------------------
    - name: Update APT cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base dependencies
      ansible.builtin.apt:
        name:
          - git
          - curl
          - wget
          - gnupg
          - lsb-release
          - apt-transport-https
          - ca-certificates
          - software-properties-common
          - python3-pip
          - python3-venv
          - python3-setuptools
          - acl
        state: present

    # -------------------------------------------------------
    # Docker Installation
    # -------------------------------------------------------
    - name: Remove conflicting Docker packages
      ansible.builtin.apt:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /tmp/docker-gpg-key
        mode: '0644'
        force: true

    - name: Add Docker GPG key to keyring
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/docker-gpg-key > /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Remove temporary GPG key file
      ansible.builtin.file:
        path: /tmp/docker-gpg-key
        state: absent

    - name: Detect system architecture
      ansible.builtin.set_fact:
        docker_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

    - name: Add Docker Repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ docker_arch }} signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
        update_cache: yes

    - name: Install Docker CE with Compose Plugin
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Enable and Start Docker Service
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ app_user }}"
        groups: docker
        append: yes

    - name: Reset connection to apply docker group changes
      ansible.builtin.meta: reset_connection

    # -------------------------------------------------------
    # Deploy Node Exporter on All VMs
    # -------------------------------------------------------
    - name: Pull Node Exporter image
      ansible.builtin.docker_image:
        name: prom/node-exporter:latest
        source: pull

    - name: Stop existing node-exporter container
      ansible.builtin.command:
        cmd: docker rm -f node-exporter
      ignore_errors: yes

    - name: Run Node Exporter Container
      ansible.builtin.docker_container:
        name: node-exporter
        image: prom/node-exporter:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ node_exporter_port }}:9100"

    - name: Wait for Node Exporter to be ready
      ansible.builtin.wait_for:
        host: localhost
        port: "{{ node_exporter_port }}"
        delay: 5
        timeout: 30
        state: started

    - name: VM setup completed
      ansible.builtin.debug:
        msg:
          - "âœ… {{ inventory_hostname }} setup completed"
          - "Node Exporter: http://{{ ansible_host | default(ansible_default_ipv4.address) }}:{{ node_exporter_port }}"

# =========================================================================
# PLAY 2: Deploy Application on App VMs
# =========================================================================
- name: Deploy Python Application on App VMs
  hosts: app_nodes
  become: true
  vars:
    project_docker_image: "ghcr.io/aatirfound42/python-cicd-app"
    project_dest: "/opt/python-cicd-app"
    project_branch: "{{ git_branch | default('main') }}"
    app_user: "{{ ansible_user }}"
    app_name: "python-cicd-app"
    app_port: 5000
    flask_env: "{{ deployment_env | default('production') }}"

  tasks:
    - name: Display deployment plan
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Deploying Application on {{ inventory_hostname }}"
          - "Docker Image: {{ project_docker_image }}:{{ project_branch }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ project_dest }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Stop existing application container
      ansible.builtin.command:
        cmd: docker rm -f python-app-instance
      ignore_errors: yes

    - name: Pull application Docker image from GHCR
      ansible.builtin.docker_image:
        name: "{{ project_docker_image }}:{{ project_branch }}"
        source: pull
        force_source: yes
      register: image_pull_result
      retries: 3
      delay: 5
      until: image_pull_result is succeeded

    - name: Run Application Container
      ansible.builtin.docker_container:
        name: python-app-instance
        image: "{{ project_docker_image }}:{{ project_branch }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ app_port }}:5000"
        env:
          FLASK_ENV: "{{ flask_env }}"
          FLASK_DEBUG: "{{ 'true' if flask_env == 'development' else 'false' }}"
        pull: yes

    - name: Wait for application to be ready
      ansible.builtin.wait_for:
        host: localhost
        port: "{{ app_port }}"
        delay: 5
        timeout: 60
        state: started

    - name: Verify application health
      ansible.builtin.uri:
        url: "http://localhost:{{ app_port }}/api/health"
        method: GET
        status_code: 200
      retries: 5
      delay: 10
      register: health_check
      until: health_check.status == 200

    - name: Application deployment completed
      ansible.builtin.debug:
        msg:
          - "âœ… Application deployed on {{ inventory_hostname }}"
          - "URL: http://{{ ansible_host | default(ansible_default_ipv4.address) }}:{{ app_port }}"
          - "Health: http://{{ ansible_host | default(ansible_default_ipv4.address) }}:{{ app_port }}/api/health"

# =========================================================================
# PLAY 3: Deploy Prometheus
# =========================================================================
- name: Deploy Prometheus on Prometheus VM
  hosts: prometheus_node
  become: true
  vars:
    project_dest: "/opt/monitoring"
    prometheus_port: 9090
    app_user: "{{ ansible_user }}"

  tasks:
    - name: Display Prometheus deployment plan
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Deploying Prometheus on {{ inventory_hostname }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Create monitoring directory
      ansible.builtin.file:
        path: "{{ project_dest }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Create Prometheus data directory
      ansible.builtin.file:
        path: "{{ project_dest }}/prometheus-data"
        state: directory
        owner: "65534"
        group: "65534"
        mode: '0755'

    - name: Generate Prometheus configuration
      ansible.builtin.template:
        src: files/prometheus.yml.j2
        dest: "{{ project_dest }}/prometheus.yml"
        mode: '0644'
        owner: "{{ app_user }}"
        group: "{{ app_user }}"

    - name: Pull Prometheus image
      ansible.builtin.docker_image:
        name: prom/prometheus:latest
        source: pull

    - name: Stop existing Prometheus container
      ansible.builtin.command:
        cmd: docker rm -f prometheus
      ignore_errors: yes

    - name: Run Prometheus Container
      ansible.builtin.docker_container:
        name: prometheus
        image: prom/prometheus:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ prometheus_port }}:9090"
        volumes:
          - "{{ project_dest }}/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
          - "{{ project_dest }}/prometheus-data:/prometheus"
        command:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'

    - name: Wait for Prometheus to be ready
      ansible.builtin.wait_for:
        host: localhost
        port: "{{ prometheus_port }}"
        delay: 10
        timeout: 60
        state: started

    - name: Verify Prometheus health
      ansible.builtin.uri:
        url: "http://localhost:{{ prometheus_port }}/-/healthy"
        method: GET
        status_code: 200
      retries: 5
      delay: 10
      register: prometheus_health
      until: prometheus_health.status == 200

    - name: Prometheus deployment completed
      ansible.builtin.debug:
        msg:
          - "âœ… Prometheus deployed successfully"
          - "URL: http://{{ ansible_host | default(ansible_default_ipv4.address) }}:{{ prometheus_port }}"

# =========================================================================
# PLAY 4: Deploy Grafana
# =========================================================================
- name: Deploy Grafana on Grafana VM
  hosts: grafana_node
  become: true
  vars:
    project_dest: "/opt/monitoring"
    grafana_port: 3000
    app_user: "{{ ansible_user }}"

  tasks:
    - name: Display Grafana deployment plan
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Deploying Grafana on {{ inventory_hostname }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Create monitoring directory
      ansible.builtin.file:
        path: "{{ project_dest }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Create Grafana datasources directory
      ansible.builtin.file:
        path: "{{ project_dest }}/grafana/datasources"
        state: directory
        mode: '0755'
        owner: "{{ app_user }}"
        group: "{{ app_user }}"

    - name: Generate Grafana datasource configuration
      ansible.builtin.template:
        src: files/grafana/datasources/datasources.yml.j2
        dest: "{{ project_dest }}/grafana/datasources/datasource.yml"
        mode: '0644'
        owner: "{{ app_user }}"
        group: "{{ app_user }}"

    - name: Pull Grafana image
      ansible.builtin.docker_image:
        name: grafana/grafana:latest
        source: pull

    - name: Stop existing Grafana container
      ansible.builtin.command:
        cmd: docker rm -f grafana
      ignore_errors: yes

    - name: Run Grafana Container
      ansible.builtin.docker_container:
        name: grafana
        image: grafana/grafana:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ grafana_port }}:3000"
        env:
          GF_SECURITY_ADMIN_PASSWORD: "admin"
          GF_USERS_ALLOW_SIGN_UP: "false"
        volumes:
          - "{{ project_dest }}/grafana/datasources:/etc/grafana/provisioning/datasources:ro"

    - name: Wait for Grafana to be ready
      ansible.builtin.wait_for:
        host: localhost
        port: "{{ grafana_port }}"
        delay: 10
        timeout: 60
        state: started

    - name: Grafana deployment completed
      ansible.builtin.debug:
        msg:
          - "âœ… Grafana deployed successfully"
          - "URL: http://{{ ansible_host | default(ansible_default_ipv4.address) }}:{{ grafana_port }}"
          - "Default credentials: admin / admin"

# =========================================================================
# PLAY 5: Final Summary
# =========================================================================
- name: Deployment Summary
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Final Deployment Summary
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ‰ MULTI-VM DEPLOYMENT COMPLETED"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ğŸ“¦ Application VMs:"
          - "   {{ groups['app_nodes'][0] }}: http://{{ hostvars[groups['app_nodes'][0]]['ansible_host'] | default(hostvars[groups['app_nodes'][0]]['ansible_default_ipv4']['address']) }}:5000"
          - "   {{ groups['app_nodes'][1] }}: http://{{ hostvars[groups['app_nodes'][1]]['ansible_host'] | default(hostvars[groups['app_nodes'][1]]['ansible_default_ipv4']['address']) }}:5000"
          - "   {{ groups['app_nodes'][2] }}: http://{{ hostvars[groups['app_nodes'][2]]['ansible_host'] | default(hostvars[groups['app_nodes'][2]]['ansible_default_ipv4']['address']) }}:5000"
          - ""
          - "ğŸ“Š Monitoring Stack:"
          - "   Prometheus: http://{{ hostvars[groups['prometheus_node'][0]]['ansible_host'] | default(hostvars[groups['prometheus_node'][0]]['ansible_default_ipv4']['address']) }}:9090"
          - "   Grafana: http://{{ hostvars[groups['grafana_node'][0]]['ansible_host'] | default(hostvars[groups['grafana_node'][0]]['ansible_default_ipv4']['address']) }}:3000"
          - ""
          - "ğŸ” Node Exporters (all VMs): Port 9100"
          - ""
          - "ğŸ” Default Credentials:"
          - "   Grafana: admin / admin (change on first login)"
          - ""
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
