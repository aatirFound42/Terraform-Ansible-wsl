# ansible/playbook.yml - Complete Two-Phase Deployment (FIXED)
- name: Deploy Python CI/CD Application with Observability
  hosts: deploy_nodes
  become: true
  
  vars:
    # Common Variables
    project_docker_image: "ghcr.io/aatirfound42/python-cicd-app"
    project_dest: "/opt/python-cicd-app"
    project_branch: "{{ git_branch | default('main') }}"
    app_user: "{{ ansible_user }}"
    
    # Docker Configuration
    docker_version: "5:24.0.0-1~ubuntu.22.04~jammy"
    
    # Application Configuration
    app_name: "python-cicd-app"
    app_port: 5000
    flask_env: "{{ deployment_env | default('production') }}"
    
    # Observability Configuration
    prometheus_port: 9090
    grafana_port: 3000
    node_exporter_port: 9100
    enable_observability: true
    
  pre_tasks:
    - name: Display deployment plan
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Deployment Plan"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Phase 1: Application Deployment"
          - "Phase 2: Observability Stack"
          - "Docker Image: {{ project_docker_image }}:{{ project_branch }}"
          - "Branch: {{ project_branch }}"
          - "Destination: {{ project_dest }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tags: [always]

  tasks:
    # =========================================================================
    # PHASE 1: APPLICATION DEPLOYMENT
    # =========================================================================
    - name: "PHASE 1: Application Deployment"
      tags: [phase1, app, never-skip]
      block:
        # -------------------------------------------------------
        # 1.1 System Preparation
        # -------------------------------------------------------
        - name: Update APT cache
          ansible.builtin.apt:
            update_cache: yes
            cache_valid_time: 3600

        - name: Install base dependencies
          ansible.builtin.apt:
            name:
              - git
              - curl
              - wget
              - gnupg
              - lsb-release
              - apt-transport-https
              - ca-certificates
              - software-properties-common
              - python3-pip
              - python3-venv
              - python3-setuptools
              - acl
            state: present

        # -------------------------------------------------------
        # 1.2 Docker Installation (Official Docker CE)
        # -------------------------------------------------------
        - name: Remove conflicting Docker packages
          ansible.builtin.apt:
            name:
              - docker
              - docker-engine
              - docker.io
              - containerd
              - runc
            state: absent

        - name: Download Docker GPG key
          ansible.builtin.get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /tmp/docker-gpg-key
            mode: '0644'
            force: true

        - name: Add Docker GPG key to keyring
          ansible.builtin.shell: |
            gpg --dearmor < /tmp/docker-gpg-key > /usr/share/keyrings/docker-archive-keyring.gpg
          args:
            creates: /usr/share/keyrings/docker-archive-keyring.gpg
          
        - name: Remove temporary GPG key file
          ansible.builtin.file:
            path: /tmp/docker-gpg-key
            state: absent

        - name: Detect system architecture
          ansible.builtin.set_fact:
            docker_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

        - name: Add Docker Repository
          ansible.builtin.apt_repository:
            repo: "deb [arch={{ docker_arch }} signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            filename: docker
            update_cache: yes

        - name: Install Docker CE with Compose Plugin
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes

        - name: Enable and Start Docker Service
          ansible.builtin.service:
            name: docker
            state: started
            enabled: yes

        - name: Add user to docker group
          ansible.builtin.user:
            name: "{{ app_user }}"
            groups: docker
            append: yes
          notify: reset ssh connection

        - name: Reset connection to apply docker group changes
          ansible.builtin.meta: reset_connection

        # -------------------------------------------------------
        # 1.3 Application Deployment
        # -------------------------------------------------------
        - name: Create application directory
          ansible.builtin.file:
            path: "{{ project_dest }}"
            state: directory
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
            mode: '0755'

        - name: Check if application container exists
          ansible.builtin.command:
            cmd: docker ps -a -q -f name=python-app-instance
          register: container_check
          changed_when: false
          ignore_errors: yes

        - name: Stop and remove existing application container
          ansible.builtin.command:
            cmd: docker rm -f python-app-instance
          when: container_check.stdout != ""
          ignore_errors: yes

        # 5. Add authentication if using private GHCR images
        # - name: Log in to GHCR
        #   community.docker.docker_login:
        #     registry_url: ghcr.io
        #     username: "{{ ghcr_username }}"
        #     password: "{{ ghcr_token }}"
        #   when: ghcr_username is defined and ghcr_token is defined
        #
        # Then modify the docker_container task to include:
        #   registry_username: "{{ ghcr_username }}"
        #   registry_password: "{{ ghcr_token }}"

        - name: Pull application Docker image from GHCR
          ansible.builtin.docker_image:
            name: "{{ project_docker_image }}:{{ project_branch }}"
            source: pull
            force_source: yes
          register: image_pull_result
          retries: 3
          delay: 5
          until: image_pull_result is succeeded

        - name: Run Application Container from GHCR image
          ansible.builtin.docker_container:
            name: python-app-instance
            image: "{{ project_docker_image }}:{{ project_branch }}"
            state: started
            restart_policy: unless-stopped
            ports:
              - "{{ app_port }}:5000"
            env:
              FLASK_ENV: "{{ flask_env }}"
              FLASK_DEBUG: "{{ 'True' if flask_env == 'development' else 'False' | string }}"
            pull: yes

        - name: Wait for application to be ready
          ansible.builtin.wait_for:
            host: localhost
            port: "{{ app_port }}"
            delay: 5
            timeout: 60
            state: started

        - name: Verify application health
          ansible.builtin.uri:
            url: "http://localhost:{{ app_port }}/api/health"
            method: GET
            status_code: 200
          retries: 5
          delay: 10
          register: health_check
          until: health_check.status == 200

        - name: Phase 1 completed
          ansible.builtin.debug:
            msg:
              - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              - "âœ… Phase 1 Completed Successfully"
              - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              - "Application: http://{{ ansible_default_ipv4.address }}:{{ app_port }}"
              - "Health: http://{{ ansible_default_ipv4.address }}:{{ app_port }}/api/health"
              - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      rescue:
        - name: Cleanup failed containers
          ansible.builtin.command:
            cmd: docker rm -f python-app-instance
          ignore_errors: yes
        
        - name: Cleanup failed images
          ansible.builtin.command:
            cmd: docker rmi "{{ project_docker_image }}:{{ project_branch }}"
          ignore_errors: yes
        
        - name: Phase 1 failed
          ansible.builtin.fail:
            msg: "âŒ Phase 1 failed. Containers cleaned up. Check logs above."

    # =========================================================================
    # PHASE 2: OBSERVABILITY STACK
    # =========================================================================
    - name: "PHASE 2: Observability Stack Deployment"
      tags: [phase2, observability]
      when: enable_observability | default(true) | bool
      block:
        # -------------------------------------------------------
        # 2.1 Setup Directories & Permissions
        # -------------------------------------------------------
        - name: Create Prometheus data directory
          ansible.builtin.file:
            path: "{{ project_dest }}/prometheus-data"
            state: directory
            owner: "65534"
            group: "65534"
            mode: '0755'
          become: true

        - name: Create Grafana directories
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: '0755'
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
          loop:
            - "{{ project_dest }}/grafana"
            - "{{ project_dest }}/grafana/datasources"

        # -------------------------------------------------------
        # 2.2 Copy Configuration Files
        # -------------------------------------------------------
        - name: Copy Docker Compose file
          ansible.builtin.copy:
            src: files/docker-compose.yml
            dest: "{{ project_dest }}/docker-compose-observability.yml"
            mode: '0644'
            owner: "{{ app_user }}"
            group: "{{ app_user }}"

        - name: Copy Prometheus Config
          ansible.builtin.copy:
            src: files/prometheus.yml
            dest: "{{ project_dest }}/prometheus.yml"
            mode: '0644'
            owner: "{{ app_user }}"
            group: "{{ app_user }}"

        - name: Copy Grafana Datasource Config
          ansible.builtin.copy:
            src: files/grafana/datasources/datasources.yml
            dest: "{{ project_dest }}/grafana/datasources/datasource.yml"
            mode: '0644'
            owner: "{{ app_user }}"
            group: "{{ app_user }}"

        # -------------------------------------------------------
        # 2.3 Deploy Observability Stack
        # -------------------------------------------------------
        - name: Check if observability stack is running
          ansible.builtin.command:
            cmd: docker ps -q -f name=prometheus -f name=grafana -f name=node-exporter
          register: observability_check
          changed_when: false
          ignore_errors: yes

        - name: Stop existing observability containers
          ansible.builtin.command:
            cmd: docker compose -f docker-compose-observability.yml down
            chdir: "{{ project_dest }}"
          when: observability_check.stdout != ""
          ignore_errors: yes
        
        - name: Pull Prometheus image
          ansible.builtin.docker_image:
            name: prom/prometheus:latest
            source: pull

        - name: Pull Grafana image
          ansible.builtin.docker_image:
            name: grafana/grafana:latest
            source: pull

        - name: Pull Node Exporter image
          ansible.builtin.docker_image:
            name: prom/node-exporter:latest
            source: pull

        - name: Deploy Observability Stack
          ansible.builtin.command:
            cmd: docker compose -f docker-compose-observability.yml up -d
            chdir: "{{ project_dest }}"
          register: compose_result
          changed_when: "'Creating' in compose_result.stdout or 'Starting' in compose_result.stdout"

        # -------------------------------------------------------
        # 2.4 Health Checks
        # -------------------------------------------------------
        - name: Wait for Prometheus to be ready
          ansible.builtin.wait_for:
            host: localhost
            port: "{{ prometheus_port }}"
            delay: 10
            timeout: 60
            state: started

        - name: Wait for Grafana to be ready
          ansible.builtin.wait_for:
            host: localhost
            port: "{{ grafana_port }}"
            delay: 10
            timeout: 60
            state: started

        - name: Verify Prometheus health
          ansible.builtin.uri:
            url: "http://localhost:{{ prometheus_port }}/-/healthy"
            method: GET
            status_code: 200
          retries: 5
          delay: 10
          register: prometheus_health
          until: prometheus_health.status == 200

        - name: Phase 2 completed
          ansible.builtin.debug:
            msg:
              - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              - "âœ… Phase 2 Completed Successfully"
              - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              - "Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}"
              - "Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}"
              - "Node Exporter: http://{{ ansible_default_ipv4.address }}:{{ node_exporter_port }}"
              - "Default Grafana credentials: admin / admin"
              - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      rescue:
        - name: Get observability stack logs on failure
          ansible.builtin.command:
            cmd: docker compose -f docker-compose-observability.yml logs --tail=50
            chdir: "{{ project_dest }}"
          register: compose_logs
          ignore_errors: yes

        - name: Display failure logs
          ansible.builtin.debug:
            msg: "{{ compose_logs.stdout_lines }}"
          when: compose_logs is defined

        - name: Phase 2 failed
          ansible.builtin.debug:
            msg: "âŒ Phase 2 deployment failed. Application is still running."

  handlers:
    - name: reset ssh connection
      ansible.builtin.meta: reset_connection

  post_tasks:
    - name: Final Deployment Summary
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ‰ DEPLOYMENT COMPLETED"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ğŸ“¦ Application:"
          - "   URL: http://{{ ansible_default_ipv4.address }}:{{ app_port }}"
          - "   Health: http://{{ ansible_default_ipv4.address }}:{{ app_port }}/api/health"
          - ""
          - "ğŸ“Š Observability Stack:"
          - "   Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}"
          - "   Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}"
          - "   Node Exporter: http://{{ ansible_default_ipv4.address }}:{{ node_exporter_port }}"
          - ""
          - "ğŸ” Default Credentials:"
          - "   Grafana: admin / admin (change on first login)"
          - ""
          - "ğŸ’¡ Next Steps:"
          - "   1. Access Grafana and change default password"
          - "   2. Import dashboards for monitoring"
          - "   3. Configure alerting rules in Prometheus"
          - ""
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tags: [always]
