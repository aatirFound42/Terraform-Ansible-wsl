# terraform/Vagrantfile
# Multi-VM configuration that works with Terraform

# Read configuration from environment or use defaults
VM_COUNT = ENV['VAGRANT_VM_COUNT'] ? ENV['VAGRANT_VM_COUNT'].to_i : 7
BASE_NAME = ENV['VAGRANT_VM_NAME'] ? ENV['VAGRANT_VM_NAME'].gsub(/-\d+$/, '') : "testnode"
CPUS = ENV['VAGRANT_CPUS'] ? ENV['VAGRANT_CPUS'].to_i : 1
MEMORY = ENV['VAGRANT_MEMORY'] ? ENV['VAGRANT_MEMORY'].to_i : 2048
BOX = ENV['VAGRANT_BOX'] || "ubuntu/jammy64"

Vagrant.configure("2") do |config|
  # Define all VMs in a loop
  (0...VM_COUNT).each do |i|
    config.vm.define "node-#{i}" do |node|
      node.vm.box = BOX
      node.vm.hostname = "#{BASE_NAME}-#{i}"
      
      # Private network with static IP to avoid DHCP conflicts
      # Each VM gets IP 192.168.56.(10 + i)
      node.vm.network "private_network", ip: "192.168.56.#{10 + i}"
      
      # Disable default synced folder to avoid issues
      node.vm.synced_folder ".", "/vagrant", disabled: true
      
      node.vm.provider "virtualbox" do |vb|
        vb.name = "#{BASE_NAME}-#{i}"
        vb.cpus = CPUS
        vb.memory = MEMORY
        vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
        vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
      end
      
      # Ensure VM is ready
      node.vm.provision "shell", inline: <<-SHELL
        echo "VM #{BASE_NAME}-#{i} is ready"
        echo "IP Address:"
        ip addr show enp0s8 | grep 'inet ' || echo "Network interface not ready"
      SHELL
    end
  end
end
